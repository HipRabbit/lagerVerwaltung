package thw.edu.javaII.port.warehouse.ui.panels;

import java.awt.*;
import javax.swing.*;
import net.miginfocom.swing.MigLayout;
import thw.edu.javaII.port.warehouse.model.Kunde;
import thw.edu.javaII.port.warehouse.ui.common.Session;

public class EditKunde extends JDialog {
    private Session ses;
    private JTextField txtVorname, txtNachname, txtLieferadresse, txtRechnungsadresse;
    private JButton btnSave, btnCancel;
    private Kunde kunde;
    private boolean canceled = false; // Neue Variable für Abbruchstatus
    private Kunde savedKunde; // Um den gespeicherten Kunden zu speichern

    public EditKunde(Session ses, JFrame parent, Kunde kunde) {
        super(parent, kunde == null ? "Kunde hinzufügen" : "Kunde bearbeiten", true);
        this.ses = ses;
        this.kunde = kunde;
        initializeUI();
        setLocationRelativeTo(parent);

        // WindowListener für das Schließen via "X"
        setDefaultCloseOperation(DO_NOTHING_ON_CLOSE);
        addWindowListener(new java.awt.event.WindowAdapter() {
            @Override
            public void windowClosing(java.awt.event.WindowEvent e) {
                canceled = true; // Setze Abbruchstatus
                dispose();
            }
        });
    }

    private void initializeUI() {
        setLayout(new MigLayout("fill, wrap 2", "[right][grow]", ""));
        setSize(400, 250);

        // Eingabefelder
        add(new JLabel("Vorname:"));
        txtVorname = new JTextField(kunde != null ? kunde.getVorname() : "", 20);
        add(txtVorname, "growx");

        add(new JLabel("Nachname:"));
        txtNachname = new JTextField(kunde != null ? kunde.getNachname() : "", 20);
        add(txtNachname, "growx");

        add(new JLabel("Lieferadresse:"));
        txtLieferadresse = new JTextField(kunde != null ? kunde.getLieferadresse() : "", 20);
        add(txtLieferadresse, "growx");

        add(new JLabel("Rechnungsadresse:"));
        txtRechnungsadresse = new JTextField(kunde != null ? kunde.getRechnungsadresse() : "", 20);
        add(txtRechnungsadresse, "growx");

        // Buttons
        btnSave = new JButton("Speichern");
        btnSave.addActionListener(e -> saveKunde());
        btnCancel = new JButton("Abbrechen");
        btnCancel.addActionListener(e -> {
            canceled = true; // Setze Abbruchstatus auch bei "Abbrechen"
            dispose();
        });
        add(btnSave, "split 2, right");
        add(btnCancel);
    }

    private void saveKunde() {
        try {
            String vorname = txtVorname.getText().trim();
            String nachname = txtNachname.getText().trim();
            String lieferadresse = txtLieferadresse.getText().trim();
            String rechnungsadresse = txtRechnungsadresse.getText().trim();

            if (vorname.isEmpty() || nachname.isEmpty() || lieferadresse.isEmpty() || rechnungsadresse.isEmpty()) {
                JOptionPane.showMessageDialog(this, "Bitte füllen Sie alle Felder aus.", "Fehler", JOptionPane.ERROR_MESSAGE);
                return;
            }

            if (kunde == null) {
                int nextId = ses.getCommunicator().getNextKundeId();
                if (nextId == -1) {
                    JOptionPane.showMessageDialog(this, "Fehler beim Generieren der Kunden-ID.", "Fehler", JOptionPane.ERROR_MESSAGE);
                    return;
                }
                kunde = new Kunde(nextId, vorname, nachname, lieferadresse, rechnungsadresse);
                boolean success = ses.getCommunicator().addKunde(kunde);
                if (success) {
                    savedKunde = kunde; // Speichere den Kunden
                    JOptionPane.showMessageDialog(this, "Kunde erfolgreich hinzugefügt.", "Erfolg", JOptionPane.INFORMATION_MESSAGE);
                    dispose();
                } else {
                    JOptionPane.showMessageDialog(this, "Fehler beim Hinzufügen des Kunden.", "Fehler", JOptionPane.ERROR_MESSAGE);
                }
            } else {
                kunde.setVorname(vorname);
                kunde.setNachname(nachname);
                kunde.setLieferadresse(lieferadresse);
                kunde.setRechnungsadresse(rechnungsadresse);
                boolean success = ses.getCommunicator().updateKunde(kunde);
                if (success) {
                    savedKunde = kunde; // Speichere den Kunden
                    JOptionPane.showMessageDialog(this, "Kunde erfolgreich aktualisiert.", "Erfolg", JOptionPane.INFORMATION_MESSAGE);
                    dispose();
                } else {
                    JOptionPane.showMessageDialog(this, "Fehler beim Aktualisieren des Kunden.", "Fehler", JOptionPane.ERROR_MESSAGE);
                }
            }
        } catch (Exception e) {
            JOptionPane.showMessageDialog(this, "Fehler: " + e.getMessage(), "Fehler", JOptionPane.ERROR_MESSAGE);
        }
    }

    public boolean isCanceled() {
        return canceled;
    }

    public Kunde getSavedKunde() {
        return savedKunde;
    }
}
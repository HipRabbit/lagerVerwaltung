package thw.edu.javaII.port.warehouse.ui.panels;

import thw.edu.javaII.port.warehouse.model.Bestellung;
import thw.edu.javaII.port.warehouse.ui.common.Session;
import thw.edu.javaII.port.warehouse.ui.model.BestellungOverviewTableModel;

import javax.swing.*;
import java.awt.*;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;

public class BestellungPage extends JPanel {
    private final Session session;
    private JTable bestellungTable;
    private BestellungOverviewTableModel tableModel;

    public BestellungPage(Session session) {
        this.session = session;
        setLayout(new BorderLayout());
        initializeUI();
    }

    private void initializeUI() {
        // Titel
        JLabel titleLabel = new JLabel("Bestellungsübersicht", SwingConstants.CENTER);
        titleLabel.setFont(new Font("Arial", Font.BOLD, 16));
        add(titleLabel, BorderLayout.NORTH);

        // Tabelle
        tableModel = new BestellungOverviewTableModel(null);
        bestellungTable = new JTable(tableModel);
        bestellungTable.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);
        bestellungTable.setRowHeight(25);
        JScrollPane scrollPane = new JScrollPane(bestellungTable);
        add(scrollPane, BorderLayout.CENTER);

        // Filter- und Button-Panel
        JPanel southPanel = new JPanel(new BorderLayout());
        
        // Filter-Panel
        FilterPanel filterPanel = new FilterPanel(session.getCommunicator());
        filterPanel.setFilterListener(new FilterPanel.FilterListener() {
            @Override
            public void onFilter(Date startDate, Date endDate, Double minAmount, Integer productId) {
                loadFilteredBestellungen(startDate, endDate, minAmount, productId);
            }

            @Override
            public void onReset() {
                loadBestellungen();
            }
        });
        southPanel.add(filterPanel, BorderLayout.NORTH);

        // Button-Panel
        JPanel buttonPanel = new JPanel(new FlowLayout(FlowLayout.RIGHT));
        JButton refreshButton = new JButton("Aktualisieren");
        refreshButton.addActionListener(e -> refresh());
        buttonPanel.add(refreshButton);

        JButton detailButton = new JButton("Details anzeigen");
        detailButton.addActionListener(e -> openDetailView());
        buttonPanel.add(detailButton);

        // Button: Bestellung hinzufügen
        JButton addBestellungButton = new JButton("Bestellung hinzufügen");
        addBestellungButton.addActionListener(e -> {
            AddBestellung dialog = new AddBestellung(
                (JFrame) SwingUtilities.getAncestorOfClass(JFrame.class, this), 
                session
            );
            dialog.setDefaultCloseOperation(JDialog.DISPOSE_ON_CLOSE);
            dialog.setModalityType(JDialog.ModalityType.APPLICATION_MODAL);
            dialog.setVisible(true);
            // Tabelle nach Schließen des Dialogs aktualisieren
            refresh();
        });
        buttonPanel.add(addBestellungButton);

        southPanel.add(buttonPanel, BorderLayout.SOUTH);
        add(southPanel, BorderLayout.SOUTH);

        // Daten laden
        loadBestellungen();
    }

    private void loadBestellungen() {
        try {
            List<Bestellung> bestellungen = session.getCommunicator().getBestellungen();
            System.out.println("loadBestellungen: Anzahl geladener Bestellungen=" + (bestellungen != null ? bestellungen.size() : 0));
            if (bestellungen == null) {
                bestellungen = new ArrayList<>();
                System.out.println("loadBestellungen: Bestellungen war null, leere Liste verwendet");
            }
            tableModel.setData(bestellungen);
            System.out.println("loadBestellungen: Tabelle aktualisiert mit " + bestellungen.size() + " Bestellungen");
        } catch (Exception e) {
            System.err.println("Fehler beim Laden der Bestellungen: " + e.getMessage());
            JOptionPane.showMessageDialog(this, "Fehler beim Laden der Bestellungen: " + e.getMessage(), "Fehler", JOptionPane.ERROR_MESSAGE);
        }
    }

    private void loadFilteredBestellungen(Date startDate, Date endDate, Double minAmount, Integer productId) {
        try {
            List<Bestellung> bestellungen = session.getCommunicator().getFilteredBestellungen(startDate, endDate, minAmount, productId);
            System.out.println("loadFilteredBestellungen: Anzahl gefilterter Bestellungen=" + (bestellungen != null ? bestellungen.size() : 0));
            if (bestellungen == null) {
                bestellungen = new ArrayList<>();
                System.out.println("loadFilteredBestellungen: Bestellungen war null, leere Liste verwendet");
            }
            tableModel.setData(bestellungen);
            System.out.println("loadFilteredBestellungen: Tabelle aktualisiert mit " + bestellungen.size() + " Bestellungen");
        } catch (Exception e) {
            System.err.println("Fehler beim Laden der gefilterten Bestellungen: " + e.getMessage());
            JOptionPane.showMessageDialog(this, "Fehler beim Laden der gefilterten Bestellungen: " + e.getMessage(), "Fehler", JOptionPane.ERROR_MESSAGE);
        }
    }

    public void refresh() {
        loadBestellungen();
    }

    private void openDetailView() {
        int selectedRow = bestellungTable.getSelectedRow();
        if (selectedRow >= 0) {
            Bestellung selectedBestellung = tableModel.getBestellungAt(selectedRow);
            BestellungDetailDialog detailDialog = new BestellungDetailDialog(null, session, selectedBestellung);
            detailDialog.setVisible(true);
        } else {
            JOptionPane.showMessageDialog(this, "Bitte wählen Sie eine Bestellung aus.", "Warnung", JOptionPane.WARNING_MESSAGE);
        }
    }
}
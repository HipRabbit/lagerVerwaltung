package thw.edu.javaII.port.warehouse.ui.panels;

import thw.edu.javaII.port.warehouse.model.Bestellung;
import thw.edu.javaII.port.warehouse.ui.common.Session;
import thw.edu.javaII.port.warehouse.ui.model.BestellungOverviewTableModel;

import javax.swing.*;
import javax.swing.table.DefaultTableCellRenderer;
import java.awt.*;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;

public class BestellungPage extends JPanel {
    private final Session session;
    private JTable bestellungTable;
    private BestellungOverviewTableModel tableModel;
    private JLabel statusLabel;

    public BestellungPage(Session session) {
        this.session = session;
        setLayout(new BorderLayout());
        initializeUI();
    }

    private void initializeUI() {
        JLabel titleLabel = new JLabel("Bestellungs체bersicht", SwingConstants.CENTER);
        titleLabel.setFont(new Font("Arial", Font.BOLD, 16));
        add(titleLabel, BorderLayout.NORTH);

        tableModel = new BestellungOverviewTableModel(null);
        bestellungTable = new JTable(tableModel);
        bestellungTable.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);
        bestellungTable.setRowHeight(25);

        bestellungTable.setDefaultRenderer(Object.class, new DefaultTableCellRenderer() {
            @Override
            public Component getTableCellRendererComponent(JTable table, Object value, boolean isSelected, boolean hasFocus, int row, int column) {
                Component c = super.getTableCellRendererComponent(table, value, isSelected, hasFocus, row, column);
                BestellungOverviewTableModel model = (BestellungOverviewTableModel) table.getModel();

                int modelRow = table.convertRowIndexToModel(row);
                Bestellung bestellung = model.getBestellungAt(modelRow);

                boolean isComplete = model.isBestellungComplete(modelRow);
                boolean hasAtLeastTwoTimestamps = model.countSetTimestamps(modelRow) >= 2;

                if (!isSelected) {
                    if (isComplete) {
                        c.setBackground(new Color(144, 238, 144));
                    } else if (hasAtLeastTwoTimestamps) {
                        c.setBackground(new Color(255, 255, 204));
                    } else {
                        c.setBackground(table.getBackground());
                    }
                } else {
                    if (isComplete) {
                        c.setBackground(new Color(144, 238, 144));
                        c.setForeground(Color.BLACK);
                    } else if (hasAtLeastTwoTimestamps) {
                        c.setBackground(new Color(255, 255, 204));
                        c.setForeground(Color.BLACK);
                    } else {
                        c.setBackground(table.getSelectionBackground());
                        c.setForeground(table.getSelectionForeground());
                    }
                }
                return c;
            }
        });

        for (int i = 0; i < bestellungTable.getColumnCount(); i++) {
            bestellungTable.getColumnModel().getColumn(i).setCellRenderer(bestellungTable.getDefaultRenderer(Object.class));
        }

        JScrollPane scrollPane = new JScrollPane(bestellungTable);
        add(scrollPane, BorderLayout.CENTER);

        JPanel southContainer = new JPanel();
        southContainer.setLayout(new BoxLayout(southContainer, BoxLayout.Y_AXIS));

        JPanel statusPanel = new JPanel(new FlowLayout(FlowLayout.LEFT));
        statusLabel = new JLabel("Erfasste Bestellungen: 0 | In Bearbeitung: 0 | Fertige Bestellungen: 0 | Insgesamter Umsatz: 0,00 EUR");
        statusPanel.add(statusLabel);
        southContainer.add(statusPanel);

        JPanel southPanel = new JPanel(new BorderLayout());
        FilterPanel filterPanel = new FilterPanel(session.getCommunicator());
        filterPanel.setFilterListener(new FilterPanel.FilterListener() {
            @Override
            public void onFilter(Date startDate, Date endDate, Double minAmount, Integer productId) {
                loadFilteredBestellungen(startDate, endDate, minAmount, productId);
            }

            @Override
            public void onReset() {
                loadBestellungen();
            }
        });
        southPanel.add(filterPanel, BorderLayout.NORTH);

        JPanel buttonPanel = new JPanel(new FlowLayout(FlowLayout.RIGHT));
        JButton refreshButton = new JButton("Aktualisieren");
        refreshButton.addActionListener(e -> refresh());
        buttonPanel.add(refreshButton);

        JButton detailButton = new JButton("Details anzeigen");
        detailButton.addActionListener(e -> openDetailView());
        buttonPanel.add(detailButton);

        JButton addBestellungButton = new JButton("Bestellung hinzuf체gen");
        addBestellungButton.addActionListener(e -> {
            AddBestellung dialog = new AddBestellung(
                (JFrame) SwingUtilities.getAncestorOfClass(JFrame.class, this), 
                session
            );
            dialog.setDefaultCloseOperation(JDialog.DISPOSE_ON_CLOSE);
            dialog.setModalityType(JDialog.ModalityType.APPLICATION_MODAL);
            dialog.setVisible(true);
            if (!dialog.isCanceled()) {
                // F체hre nur Aktionen aus, wenn der Dialog nicht abgebrochen wurde
                refresh();
            }
        });
        buttonPanel.add(addBestellungButton);

        southPanel.add(buttonPanel, BorderLayout.SOUTH);
        southContainer.add(southPanel);

        add(southContainer, BorderLayout.SOUTH);

        loadBestellungen();
    }

    private void updateStatusCounts() {
        int erfasst = 0;
        int inBearbeitung = 0;
        int fertig = 0;

        for (int i = 0; i < tableModel.getRowCount(); i++) {
            boolean isComplete = tableModel.isBestellungComplete(i);
            boolean hasAtLeastTwoTimestamps = tableModel.countSetTimestamps(i) >= 2;

            if (isComplete) {
                fertig++;
            } else if (hasAtLeastTwoTimestamps) {
                inBearbeitung++;
            } else {
                erfasst++;
            }
        }

        // Berechnung des Gesamtumsatzes
        double totalRevenue = tableModel.calculateTotalRevenue();
        String formattedRevenue = tableModel.getCurrencyFormat().format(totalRevenue);

        statusLabel.setText(String.format("Erfasste Bestellungen: %d | In Bearbeitung: %d | Fertige Bestellungen: %d | Insgesamter Umsatz: %s EUR",
                erfasst, inBearbeitung, fertig, formattedRevenue));
    }

    private void loadBestellungen() {
        try {
            List<Bestellung> bestellungen = session.getCommunicator().getBestellungen();
            System.out.println("loadBestellungen: Anzahl geladener Bestellungen=" + (bestellungen != null ? bestellungen.size() : 0));
            if (bestellungen == null) {
                bestellungen = new ArrayList<>();
                System.out.println("loadBestellungen: Bestellungen war null, leere Liste verwendet");
            }
            tableModel.setData(bestellungen);
            System.out.println("loadBestellungen: Tabelle aktualisiert mit " + bestellungen.size() + " Bestellungen");
            updateStatusCounts();
        } catch (Exception e) {
            System.err.println("Fehler beim Laden der Bestellungen: " + e.getMessage());
            JOptionPane.showMessageDialog(this, "Fehler beim Laden der Bestellungen: " + e.getMessage(), "Fehler", JOptionPane.ERROR_MESSAGE);
        }
    }

    private void loadFilteredBestellungen(Date startDate, Date endDate, Double minAmount, Integer productId) {
        try {
            List<Bestellung> bestellungen = session.getCommunicator().getFilteredBestellungen(startDate, endDate, minAmount, productId);
            System.out.println("loadFilteredBestellungen: Anzahl gefilterter Bestellungen=" + (bestellungen != null ? bestellungen.size() : 0));
            if (bestellungen == null) {
                bestellungen = new ArrayList<>();
                System.out.println("loadFilteredBestellungen: Bestellungen war null, leere Liste verwendet");
            }
            tableModel.setData(bestellungen);
            System.out.println("loadFilteredBestellungen: Tabelle aktualisiert mit " + bestellungen.size() + " Bestellungen");
            updateStatusCounts();
        } catch (Exception e) {
            System.err.println("Fehler beim Laden der gefilterten Bestellungen: " + e.getMessage());
            JOptionPane.showMessageDialog(this, "Fehler beim Laden der gefilterten Bestellungen: " + e.getMessage(), "Fehler", JOptionPane.ERROR_MESSAGE);
        }
    }

    public void refresh() {
        loadBestellungen();
    }

    private void openDetailView() {
        int selectedRow = bestellungTable.getSelectedRow();
        if (selectedRow >= 0) {
            int modelRow = bestellungTable.convertRowIndexToModel(selectedRow);
            Bestellung selectedBestellung = tableModel.getBestellungAt(modelRow);
            BestellungDetailDialog detailDialog = new BestellungDetailDialog(null, session, selectedBestellung);
            detailDialog.setVisible(true);
            refresh();
        } else {
            JOptionPane.showMessageDialog(this, "Bitte w채hlen Sie eine Bestellung aus.", "Warnung", JOptionPane.WARNING_MESSAGE);
        }
    }
}